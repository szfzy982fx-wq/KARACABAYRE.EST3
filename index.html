<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KARACABAYRE.EST - v54 (Button Fit Fix)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db; 
            --shared: #9b59b6;    
            --accent: #27ae60;    
            --danger: #c0392b;    
            --link-color: #e67e22; 
            --calc-color: #2980b9; 
            --tool-bg: #f8f9fa;
            --sold: #d63031;
            --warning-bg: #fff3cd;
            --alert-bg: #f8d7da;
            --whatsapp: #25D366;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f3; margin: 0; padding: 20px; color: #333; }
        
        /* GiriÅŸ EkranÄ± */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .login-box { background: white; padding: 30px; border-radius: 10px; text-align: center; width: 300px; }
        .login-box input { width: 80%; padding: 10px; margin: 15px 0; font-size: 18px; text-align: center; border: 2px solid #ddd; border-radius: 5px; }
        .login-box button { width: 90%; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* Ana YapÄ± */
        #appContainer { display: none; }
        .container { max-width: 1800px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        
        /* Toolbar */
        .tools-bar { display: flex; gap: 10px; background: var(--tool-bg); padding: 10px; border-radius: 6px; margin-bottom: 25px; border: 1px solid #ddd; flex-wrap: wrap; }
        .tool-btn { border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 700; color: white; display: flex; align-items: center; gap: 8px; transition: all 0.2s; text-decoration: none; position: relative; }
        .tool-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-unutma { background-color: var(--danger); }
        .btn-crm { background-color: var(--accent); }
        .btn-calc { background-color: var(--calc-color); }
        .btn-link { background-color: var(--link-color); }
        .btn-backup { background: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        .notification-badge { position: absolute; top: -8px; right: -8px; background-color: red; color: white; border-radius: 50%; padding: 4px 7px; font-size: 10px; border: 2px solid white; display: none; }

        /* Form AlanÄ± */
        .input-panel { background: #fdfdfd; padding: 20px; border: 1px solid #ddd; border-left: 6px solid var(--primary); margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
        .form-group label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 5px; color: #555; text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        .currency-group { display: flex; gap: 5px; }
        .currency-group select { width: 70px; flex-shrink: 0; background: #eee; font-weight: bold; }
        .auth-box { grid-column: span 2; display: flex; gap: 15px; background: #eafaf1; padding: 15px; border: 1px dashed var(--accent); border-radius: 6px; }
        .form-buttons { grid-column: span 2; display: flex; gap: 10px; margin-top: 10px; }
        .btn-save { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 2; }
        .btn-delete-rec { background: var(--danger); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; display: none; }
        .btn-cancel { background: #7f8c8d; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; display: none; }

        /* Tablo ve Liste */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; table-layout: fixed; }
        th { background: #34495e; color: white; padding: 12px; text-align: left; vertical-align: middle; }
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; word-wrap: break-word; }
        tr:hover { background: #f9f9f9; }
        
        tr.row-sold { background-color: #fff5f5; color: #999; }
        tr.row-rented { background-color: #fcf8e3; color: #777; }
        tr.row-selected { background-color: #d1f2eb !important; }
        
        .badge { padding: 3px 6px; border-radius: 3px; color: white; font-size: 10px; font-weight: bold; display:inline-block; margin-bottom: 2px; }
        .satilik { background: #27ae60; } .kiralik { background: #e67e22; } .kirmizi-etiket { background: var(--sold) !important; }
        .badge-own { background: var(--secondary); } .badge-shared { background: var(--shared); }
        .badge-sicak { background: #e74c3c; } .badge-ilik { background: #f39c12; } .badge-soguk { background: #95a5a6; }
        .type-text { display: block; font-weight: 900; text-transform: uppercase; font-size: 12px; margin-top: 3px; color: #444; }
        
        /* Linkler */
        .direct-link-btn { display: inline-block; background-color: #3498db; color: white; text-decoration: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; font-weight: 600; }
        .link-sahibinden { background-color: #f1c40f; color: black; } 
        .link-hepsi { background-color: #e74c3c; } 
        .link-maps { background-color: #27ae60; color: white; } 
        .link-dosya { background-color: #95a5a6; border: 1px solid #7f8c8d; }

        /* Filtre */
        .filter-bar { background: var(--primary); padding: 15px; border-radius: 6px; display: flex; gap: 10px; flex-wrap: wrap; color: white; align-items: center; }
        .filter-bar input, .filter-bar select { padding: 8px; border: none; border-radius: 4px; color: #333; }
        .btn-clear-filter { background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: auto; }

        /* Butonlar */
        .btn-print-selected { background: #8e44ad; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; display:flex; align-items:center; gap:5px; }
        .btn-whatsapp-selected { background: var(--whatsapp); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; display:flex; align-items:center; gap:5px; margin-left:5px; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; overflow-y: hidden; }
        .modal-content { background: white; margin: 3% auto; padding: 25px; width: 95%; border-radius: 8px; position: relative; max-height: 85vh; display: flex; flex-direction: column; overflow-y: auto; }
        .tool-modal-content { width: 450px; margin: 10% auto; }
        .checklist-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .checklist-item.checked span { text-decoration: line-through; color: #aaa; }
        
        .crm-header { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .crm-tab { padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 6px; border: 1px solid #eee; background: #f9f9f9; }
        .crm-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        .crm-input-panel { background: #f1f2f6; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 5px solid var(--accent); }
        .crm-input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .crm-buttons { display: flex; gap: 10px; margin-top: 15px; }
        
        .imar-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .btn-imar-select { padding: 15px; background: #34495e; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; text-align: left; display: flex; align-items: center; justify-content: space-between; }
        .btn-imar-select:hover { background: #e67e22; }

        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calc-btn { padding: 15px; font-size: 18px; cursor: pointer; background: #eee; border: none; border-radius: 4px; } 
        .calc-btn.op { background: var(--secondary); color: white; } .calc-btn.eq { background: var(--accent); color: white; grid-column: span 2; }
        .calc-screen { width: 95%; padding: 10px; font-size: 24px; text-align: right; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .currency-board { display: flex; flex-direction: column; gap: 15px; }
        .currency-row { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
        .result-box { margin-top: 15px; padding: 10px; background: #f0f9ff; border: 1px solid #bce8f1; color: #31708f; font-weight: bold; border-radius: 4px; text-align: center; font-size: 1.1em; }
        .tab-buttons { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { border-bottom-color: var(--secondary); color: var(--secondary); font-weight: bold; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        
        .print-only { display: none; }
        
        /* --- YAZDIRMA AYARLARI --- */
        @media print { 
            body, .container { background-color: white !important; -webkit-print-color-adjust: exact; margin: 0; padding: 0; }
            .input-panel, .filter-bar, .backup-controls, .tools-bar, #loginOverlay, .no-print, .btn-print-selected, .btn-whatsapp-selected { display: none !important; } 
            .print-only { display: table-cell !important; } 
            #appContainer { display: block !important; } 
            
            table { width: 100%; font-size: 9px; } 
            th, td { border: 1px solid #ddd; padding: 3px !important; color: black; vertical-align: top; } 
            
            .badge { display: inline-block; margin-bottom: 1px; font-size: 8px !important; border: 1px solid #ccc; padding: 1px 2px; }
            td br { display: block; margin: 1px 0; }
            
            body.print-selected-mode tbody tr:not(.row-selected) { display: none !important; }
            body.print-selected-mode .select-col-header, body.print-selected-mode .select-col-cell { display: none !important; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2>ğŸ”’ GÃœVENLÄ° GÄ°RÄ°Å</h2>
        <p>KaracabayRE.EST v54</p>
        <input type="password" id="loginPin" placeholder="Åifre (1923)" inputmode="numeric">
        <button onclick="checkLogin()">GÄ°RÄ°Å YAP</button>
    </div>
</div>

<div id="appContainer">
    <div class="container">
        <header>
            <div><h1>ğŸ¢ KARACABAYRE.EST <span style="font-size:12px; color:#27ae60; border:1px solid #27ae60; padding:2px 8px; border-radius:10px;">v54 (Button Fit Fix)</span></h1></div>
            <div class="backup-controls">
                <input type="file" id="fileUpload" style="display:none;" onclick="this.value=null" onchange="uploadData(this)">
                <button class="btn-backup" onclick="document.getElementById('fileUpload').click()">ğŸ“‚ YÃœKLE</button>
                <button class="btn-backup" onclick="downloadData()">ğŸ’¾ YEDEKLE</button>
            </div>
        </header>

        <div class="tools-bar">
            <button class="tool-btn btn-unutma" onclick="openModal('checklistModal'); renderChecklist();">
                <i class="fa-solid fa-bell"></i> UNUTMA!
                <span id="chkBadge" class="notification-badge">0</span>
            </button>
            
            <button class="tool-btn btn-crm" onclick="openCRM()"><i class="fa-solid fa-users"></i> CRM</button>
            <button class="tool-btn btn-calc" onclick="openModal('calcModal')"><i class="fa-solid fa-calculator"></i> Hesap Mak.</button>
            <button class="tool-btn btn-calc" onclick="openModal('currencyModal'); fetchCurrency();"><i class="fa-solid fa-money-bill-transfer"></i> DÃ¶viz (v27)</button>
            <button class="tool-btn btn-calc" onclick="openModal('realEstateCalcModal')"><i class="fa-solid fa-file-contract"></i> Emlak (v27)</button>
            <a href="https://www.hesapkurdu.com/konut-kredisi/h/gayrimenkul-deger-artis-kazanci-vergisi-hesaplama" target="_blank" class="tool-btn btn-calc"><i class="fa-solid fa-calculator"></i> DAKV</a>
            
            <a href="https://parselsorgu.tkgm.gov.tr/" target="_blank" class="tool-btn btn-link"><i class="fa-solid fa-map-location-dot"></i> TKGM Parsel</a>
            <button class="tool-btn btn-link" onclick="openModal('eImarModal')"><i class="fa-solid fa-city"></i> BELEDÄ°YELER</button>
        </div>

        <div class="input-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span id="formTitle" style="font-weight:bold; color:var(--primary); font-size:1.1em;">â• Yeni PortfÃ¶y Ekle</span>
                <button id="btnCancel" class="btn-cancel" onclick="resetForm()">TEMÄ°ZLE / Ä°PTAL</button>
            </div>
            <div class="form-grid">
                <div class="form-group"><label>PORTFÃ–Y SAHÄ°BÄ°</label><select id="inpOwnership"><option>BANA AÄ°T</option><option>PAYLAÅIMLI</option></select></div>
                <div class="form-group"><label>Menkul Cinsi</label><select id="inpType"></select></div>
                <div class="form-group"><label>Ä°ÅŸlem TÃ¼rÃ¼</label><select id="inpStatus"><option>SatÄ±lÄ±k</option><option>KiralÄ±k</option><option>Devren</option><option style="color:red; font-weight:bold;">SatÄ±ldÄ±</option><option style="color:red; font-weight:bold;">KiralandÄ±</option></select></div>
                
                <div class="form-group"><label>Ä°L</label><select id="inpCity" onchange="handleCityChange('inpCity', 'inpDistrict', 'dl_mahalle_ekle')"><option value="Antalya">Antalya</option></select></div>
                
                <div class="form-group"><label>Ä°lÃ§e</label><select id="inpDistrict" onchange="loadMahalleler('inpCity', 'inpDistrict', 'dl_mahalle_ekle')"><option value="">SeÃ§iniz</option></select></div>
                <div class="form-group"><label>Mahalle</label><input type="text" list="dl_mahalle_ekle" id="inpNeighborhood" placeholder="YazÄ±nÄ±z" autocomplete="off"><datalist id="dl_mahalle_ekle"></datalist></div>
                
                <div class="form-group"><label>Oda SayÄ±sÄ±</label><input type="text" id="inpRooms" placeholder="Ã–rn: 3+1, 5+2"></div>
                
                <div class="form-group"><label>BulunduÄŸu Kat</label><select id="inpFloor"></select></div>
                <div class="form-group"><label>Bina Kat SayÄ±sÄ±</label><input type="number" id="inpFloorCount" placeholder="Manuel"></div>
                <div class="form-group"><label>BrÃ¼t mÂ²</label><input type="number" id="inpGross" placeholder="mÂ²"></div>
                <div class="form-group"><label>Net mÂ²</label><input type="number" id="inpNet" placeholder="mÂ²"></div>
                <div class="form-group"><label>Fiyat</label>
                    <div class="currency-group">
                        <input type="text" id="inpPrice" placeholder="5.000.000" oninput="formatCurrency(this)">
                        <select id="inpCurrency"><option value="â‚º">TL</option><option value="$">USD</option><option value="â‚¬">EUR</option><option value="Â£">GBP</option></select>
                    </div>
                </div>
                <div class="auth-box">
                    <div class="form-group" style="flex:1;"><label>Yetki BaÅŸlangÄ±Ã§</label><input type="date" id="inpAuthStart"></div>
                    <div class="form-group" style="flex:1;"><label>Yetki BitiÅŸ</label><input type="date" id="inpAuthEnd"></div>
                </div>
                <div class="form-group"><label>MÃ¼ÅŸteri Ad Soyad</label><input type="text" id="inpRef"></div>
                <div class="form-group"><label>MÃ¼ÅŸteri Telefon</label><input type="text" id="inpPhone" placeholder="0 (5XX) XXX XX XX" maxlength="17" oninput="formatPhone(this)"></div>
                <div class="form-group"><label>Dosya / Link / Konum</label><textarea id="inpLink" placeholder="Link, Konum Linki veya Dosya Yolu..." rows="1" class="auto-expand" oninput="autoResize(this)"></textarea></div>
                <div class="form-group" style="grid-column:span 2;"><label>AÃ§Ä±klama</label><textarea id="inpDesc" class="auto-expand" placeholder="DetaylÄ± aÃ§Ä±klama..." oninput="autoResize(this)"></textarea></div>
                <div class="form-buttons">
                    <button id="btnSave" class="btn-save" onclick="handleSave()">KAYDET</button>
                    <button id="btnDelete" class="btn-delete-rec" onclick="deleteFromForm()">ğŸ—‘ï¸ SÄ°L</button>
                </div>
            </div>
        </div>

        <div class="filter-bar">
            <span>ğŸ” ARA:</span> <input type="text" id="searchBox" placeholder="Ä°sim, Tel, Not..." onkeyup="renderTable()" style="width:140px;">
            <select id="filterOwnership" onchange="renderTable()" style="width:120px;"><option value="all">TÃ¼m PortfÃ¶yler</option><option>BANA AÄ°T</option><option>PAYLAÅIMLI</option></select>
            <select id="filterType" onchange="renderTable()" style="width:130px;"><option value="all">TÃ¼m Menkuller</option></select>
            <select id="filterStatus" onchange="renderTable()" style="width:110px;"><option value="all">Durum</option><option>SatÄ±lÄ±k</option><option>KiralÄ±k</option><option>Devren</option><option style="color:red;">SatÄ±ldÄ±</option><option style="color:red;">KiralandÄ±</option></select>
            
            <select id="filterCity" onchange="handleCityChange('filterCity', 'filterDistrict', 'dl_mahalle_filtre'); renderTable();" style="width:110px;">
                </select>
            
            <select id="filterDistrict" onchange="loadMahalleler('filterCity', 'filterDistrict', 'dl_mahalle_filtre'); renderTable();"><option value="all">Ä°lÃ§e</option></select>
            <input type="text" list="dl_mahalle_filtre" id="filterNeighborhood" placeholder="Mahalle" onkeyup="renderTable()" style="width:100px;" autocomplete="off"><datalist id="dl_mahalle_filtre"></datalist>
            
            <input type="text" id="filterRooms" placeholder="Oda" onkeyup="renderTable()" style="width:80px;">
            <input type="text" id="filterMinPrice" placeholder="Min" oninput="formatCurrency(this); renderTable()" style="width:80px;"> 
            <input type="text" id="filterMaxPrice" placeholder="Max" oninput="formatCurrency(this); renderTable()" style="width:80px;">
            <button class="btn-clear-filter" onclick="clearFilters()" title="Filtreleri ve SeÃ§imleri SÄ±fÄ±rla"><i class="fa-solid fa-rotate-left"></i> TEMÄ°ZLE</button>
            
            <button class="btn-print-selected" onclick="printSelected()">
                <i class="fa-solid fa-check-double"></i> SEÃ‡Ä°LENLERÄ° YAZDIR
            </button>
            <button class="btn-whatsapp-selected" onclick="sendSelectedToWhatsapp()">
                <i class="fa-brands fa-whatsapp"></i> WP GÃ–NDER
            </button>
        </div>

        <table id="portfolioTable">
            <thead>
                <tr>
                    <th width="3%" class="select-col-header no-print">
                        SeÃ§<br>
                        <input type="checkbox" id="masterCheckbox" onchange="toggleAllSelections(this)" style="transform:scale(1.3); cursor:pointer;" title="TÃ¼mÃ¼nÃ¼ SeÃ§/KaldÄ±r">
                    </th> 
                    <th width="10%">TÃ¼r / Durum</th>
                    <th width="12%">Lokasyon</th>
                    <th width="8%">Ã–zellikler</th>
                    <th width="10%">mÂ² (BrÃ¼t/Net)</th>
                    <th width="11%">Fiyat</th>
                    <th width="14%">MÃ¼ÅŸteri / Tel</th>
                    <th width="9%">Yetki</th>
                    <th class="no-print" width="6%" style="text-align:center;">Linkler</th>
                    <th class="no-print" width="5%" style="text-align:center;">Not</th>
                    <th class="no-print" width="8%">Ä°ÅŸlem</th>
                    <th class="print-only">AÃ§Ä±klama / Notlar</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="legal-footer">Veriler yerel tarayÄ±cÄ±da saklanÄ±r. (v54 Button Fit Fix)</div>
    </div>
</div>

<div id="eImarModal" class="modal" onclick="closeModalOutside(event, 'eImarModal')">
    <div class="modal-content tool-modal-content" style="width:500px;">
        <div style="display:flex;justify-content:space-between; margin-bottom:15px; border-bottom:2px solid #e67e22; padding-bottom:10px;">
            <h3 style="color:#e67e22; margin:0;"><i class="fa-solid fa-city"></i> Antalya Belediyeleri</h3>
            <span onclick="closeModal('eImarModal')" style="cursor:pointer;font-size:24px;">&times;</span>
        </div>
        <div class="imar-grid">
            <button class="btn-imar-select" onclick="window.open('https://muratpasa-bld.gov.tr/', '_blank')">MuratpaÅŸa (Resmi) <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.muratpasa.bel.tr/', '_blank')">MuratpaÅŸa (Alternatif) <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.kepez-bld.gov.tr/', '_blank')">Kepez <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.konyaalti.bel.tr/', '_blank')">KonyaaltÄ± <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://dosemealti.bel.tr/', '_blank')">DÃ¶ÅŸemealtÄ± <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.aksu.bel.tr/', '_blank')">Aksu <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.alanya.bel.tr/', '_blank')">Alanya <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.serik.bel.tr/', '_blank')">Serik <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.manavgat.bel.tr/', '_blank')">Manavgat <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.kemer.bel.tr/', '_blank')">Kemer <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.korkuteli.bel.tr/', '_blank')">Korkuteli <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.gazipasa.bel.tr/', '_blank')">GazipaÅŸa <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.kumluca.bel.tr/', '_blank')">Kumluca <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.finike.bel.tr/', '_blank')">Finike <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            <button class="btn-imar-select" onclick="window.open('https://www.kas.bel.tr/', '_blank')">KaÅŸ <i class="fa-solid fa-arrow-up-right-from-square"></i></button>
        </div>
        <div style="font-size:11px; color:#666; margin-top:10px; text-align:center;">*GÃ¼venlik nedeniyle baÄŸlantÄ±lar yeni sekmede "Belediye Ana SayfasÄ±" olarak aÃ§Ä±lÄ±r.</div>
    </div>
</div>

<div id="checklistModal" class="modal" onclick="closeModalOutside(event, 'checklistModal')"><div class="modal-content tool-modal-content"><div style="display:flex;justify-content:space-between; margin-bottom:15px; border-bottom:2px solid #c0392b; padding-bottom:10px;"><h3 style="color:#c0392b; margin:0;"><i class="fa-solid fa-bell"></i> UNUTMA!</h3><span onclick="closeModal('checklistModal')" style="cursor:pointer;font-size:24px;">&times;</span></div><div style="display:flex; gap:10px; margin-bottom:15px;"><input type="text" id="newCheckItem" placeholder="HatÄ±rlatma ekle..." onkeypress="if(event.key==='Enter') addCheckItem()"><button class="btn-save" style="flex:0; width:60px; background:#c0392b;" onclick="addCheckItem()">EKLE</button></div><div id="checklistContainer" style="max-height:400px; overflow-y:auto; border:1px solid #eee; border-radius:4px;"></div></div></div>

<div id="crmModal" class="modal" onclick="closeModalOutside(event, 'crmModal')">
    <div class="modal-content">
        <div style="display:flex;justify-content:space-between; margin-bottom:10px;">
            <h3>ğŸ‘¥ MÃ¼ÅŸteri Ä°liÅŸkileri (CRM)</h3>
            <span onclick="closeModal('crmModal')" style="cursor:pointer;font-size:24px;">&times;</span>
        </div>
        <div class="crm-header">
            <div id="tab1" class="crm-tab active" onclick="switchCRMTab('investors')">ğŸ’° Talep Havuzu</div>
            <div id="tab2" class="crm-tab" onclick="switchCRMTab('network')">ğŸ“¢ Etki Ã‡evresi</div>
        </div>
        <div id="crmInvestors" class="crm-section" style="display:block;">
            <div class="crm-input-panel">
                <div class="crm-input-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="form-group"><label>Ad Soyad</label><input type="text" id="invName"></div>
                    <div class="form-group"><label>Telefon</label><input type="text" id="invPhone" placeholder="05XX..."></div>
                    <div class="form-group"><label>Talep Tipi</label><select id="invType"><option>Daire</option><option>Villa</option><option>Arsa</option><option>Ä°ÅŸyeri</option><option>YatÄ±rÄ±mlÄ±k</option></select></div>
                    <div class="form-group"><label>BÃ¶lge Tercihi</label><input type="text" id="invRegion" placeholder="Lara, KonyaaltÄ±..."></div>
                    <div class="form-group"><label>BÃ¼tÃ§e (Max)</label><input type="text" id="invBudget" oninput="formatCurrency(this)"></div>
                    <div class="form-group"><label>Durum</label><select id="invStatus"><option value="SÄ±cak">ğŸ”¥ SÄ±cak (Acil)</option><option value="IlÄ±k">âš–ï¸ IlÄ±k (Normal)</option><option value="SoÄŸuk">ğŸ§Š SoÄŸuk (Beklemede)</option></select></div>
                    <div class="form-group" style="grid-column: span 2;"><label>Notlar</label><textarea id="invNote" rows="1" class="auto-expand"></textarea></div>
                </div>
                <div class="crm-buttons">
                    <button class="btn-save" onclick="saveCRMInvestor()" id="btnInvSave">KAYDET</button>
                    <button id="btnInvDelete" class="btn-delete-rec" onclick="deleteCRMInvestor()">SÄ°L</button>
                    <button id="btnInvCancel" class="btn-cancel" onclick="resetCRMForm('investors')">Ä°PTAL</button>
                </div>
            </div>
            <div class="table-scroll-wrapper">
                <table class="crm-table">
                    <thead><tr><th width="15%">Ad Soyad</th><th width="12%">Telefon</th><th width="20%">Talep / BÃ¶lge</th><th width="13%">BÃ¼tÃ§e</th><th width="10%">Durum</th><th width="20%">Notlar</th><th width="10%">Ä°ÅŸlem</th></tr></thead>
                    <tbody id="investorTableBody"></tbody>
                </table>
            </div>
        </div>
        <div id="crmNetwork" class="crm-section" style="display:none;">
            <div class="crm-input-panel">
                <div class="crm-input-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="form-group"><label>Ad Soyad</label><input type="text" id="netName"></div>
                    <div class="form-group"><label>Telefon</label><input type="text" id="netPhone"></div>
                    <div class="form-group"><label>Meslek / Unvan</label><input type="text" id="netJob"></div>
                    <div class="form-group"><label>Åehir</label><input type="text" id="netCity" value="Antalya"></div>
                    <div class="form-group"><label>YakÄ±nlÄ±k / Ref.</label><input type="text" id="netRelation" placeholder="ArkadaÅŸ, Eski MÃ¼ÅŸteri..."></div>
                    <div class="form-group"><label>Son Arama</label><input type="date" id="netLastCall"></div>
                    <div class="form-group" style="grid-column: span 3;"><label>AÃ§Ä±klama / Potansiyel</label><textarea id="netNote" rows="1" class="auto-expand"></textarea></div>
                </div>
                <div class="crm-buttons">
                    <button class="btn-save" onclick="saveCRMNetwork()" id="btnNetSave">KAYDET</button>
                    <button id="btnNetDelete" class="btn-delete-rec" onclick="deleteCRMNetwork()">SÄ°L</button>
                    <button id="btnNetCancel" class="btn-cancel" onclick="resetCRMForm('network')">Ä°PTAL</button>
                </div>
            </div>
            <div class="table-scroll-wrapper">
                <table class="crm-table">
                    <thead><tr><th width="16%">Ad Soyad</th><th width="12%">Meslek/Åehir</th><th width="12%">Telefon</th><th width="10%">YakÄ±nlÄ±k</th><th width="10%">Son Arama</th><th width="8%">Durum</th><th width="14%">Notlar</th><th width="18%">Ä°ÅŸlem</th></tr></thead>
                    <tbody id="networkTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="descModal" class="modal" onclick="closeModalOutside(event, 'descModal')"><div class="modal-content"><span onclick="closeModal('descModal')" style="cursor:pointer;float:right;font-size:24px;">&times;</span><h3>ğŸ“ Notlar</h3><p id="modalText" style="white-space: pre-wrap; margin-top:10px;"></p></div></div>

<div id="calcModal" class="modal" onclick="closeModalOutside(event, 'calcModal')">
    <div class="modal-content tool-modal-content">
        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
            <h3>ğŸ§® Hesap Makinesi</h3><span onclick="closeModal('calcModal')" style="cursor:pointer;font-size:24px;">&times;</span>
        </div>
        <input type="text" id="calcDisplay" class="calc-screen" readonly>
        <div class="calc-grid">
            <button class="calc-btn" onclick="calcInput('7')">7</button>
            <button class="calc-btn" onclick="calcInput('8')">8</button>
            <button class="calc-btn" onclick="calcInput('9')">9</button>
            <button class="calc-btn op" onclick="calcInput('/')">Ã·</button>
            <button class="calc-btn" onclick="calcInput('4')">4</button>
            <button class="calc-btn" onclick="calcInput('5')">5</button>
            <button class="calc-btn" onclick="calcInput('6')">6</button>
            <button class="calc-btn op" onclick="calcInput('*')">Ã—</button>
            <button class="calc-btn" onclick="calcInput('1')">1</button>
            <button class="calc-btn" onclick="calcInput('2')">2</button>
            <button class="calc-btn" onclick="calcInput('3')">3</button>
            <button class="calc-btn op" onclick="calcInput('-')">-</button>
            <button class="calc-btn" onclick="calcInput('0')">0</button>
            <button class="calc-btn" onclick="calcInput('.')">.</button>
            <button class="calc-btn op" onclick="calcInput('%')">%</button>
            <button class="calc-btn op" onclick="calcInput('+')">+</button>
            <button class="calc-btn" onclick="calcClear()">C</button>
            <button class="calc-btn eq" onclick="calcResult()">=</button>
        </div>
    </div>
</div>

<div id="currencyModal" class="modal" onclick="closeModalOutside(event, 'currencyModal')">
    <div class="modal-content tool-modal-content">
        <div style="display:flex;justify-content:space-between; margin-bottom:15px;">
            <h3>ğŸ’± DÃ¶viz (Efektif SatÄ±ÅŸ)</h3><span onclick="closeModal('currencyModal')" style="cursor:pointer;font-size:24px;">&times;</span>
        </div>
        <div style="margin-bottom:15px;">
            <a href="https://www.tcmb.gov.tr/wps/wcm/connect/tr/tcmb+tr/main+page+site+area/bugun" target="_blank" class="tool-btn" style="width:100%; justify-content:center; text-align:center; background:#fef9e7; border:1px solid #f39c12; color:#d35400;"> TCMB KurlarÄ±nÄ± AÃ§ </a>
            <div style="font-size:11px; color:#666; margin-top:5px; text-align:center;">*Otomatik deÄŸerler piyasa verisidir, manuel gÃ¼ncelleyebilirsiniz.</div>
        </div>
        <div class="currency-board">
            <div class="currency-row">
                <span class="curr-flag">ğŸ‡ºğŸ‡¸</span>
                <span class="curr-name">USD / TRY</span>
                <div>
                    <div style="font-size:10px; color:#888;">SatÄ±ÅŸ</div>
                    <input type="number" id="usdRate" class="curr-input" style="width:80px; padding:5px; border:1px solid #ddd; border-radius:3px;">
                </div>
            </div>
            <div class="currency-row">
                <span class="curr-flag">ğŸ‡ªğŸ‡º</span>
                <span class="curr-name">EUR / TRY</span>
                <div>
                    <div style="font-size:10px; color:#888;">SatÄ±ÅŸ</div>
                    <input type="number" id="eurRate" class="curr-input" style="width:80px; padding:5px; border:1px solid #ddd; border-radius:3px;">
                </div>
            </div>
        </div>
        <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
        <div class="form-group">
            <label>Ã‡evrilecek Tutar</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="calcCurrAmount" placeholder="1000" style="flex:2;">
                <select id="calcCurrType" style="flex:1;">
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>
        </div>
        <button class="btn-save" style="width:100%; margin-top:10px;" onclick="calculateCurrencyTotal()">HESAPLA (TL)</button>
        <div id="currencyTotalRes" class="result-box" style="display:none;">
            <span id="currResText">0,00 TL</span>
        </div>
    </div>
</div>

<div id="realEstateCalcModal" class="modal" onclick="closeModalOutside(event, 'realEstateCalcModal')">
    <div class="modal-content tool-modal-content">
        <div style="display:flex;justify-content:space-between; margin-bottom:10px;">
            <h3>ğŸ§¾ Emlak HesaplamalarÄ±</h3><span onclick="closeModal('realEstateCalcModal')" style="cursor:pointer;font-size:24px;">&times;</span>
        </div>
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('tabTapu')">Tapu & Komisyon</button>
            <button class="tab-btn" onclick="switchTab('tabEmsal')">Emsal</button>
            <button class="tab-btn" onclick="switchTab('tabVergi')">Emlak Vergisi</button>
        </div>
        <div id="tabTapu" class="tab-content active">
            <div class="form-group"><label>SatÄ±ÅŸ Bedeli (TL)</label><input type="number" id="calcPriceComp" placeholder="Ã–rn: 5000000"></div>
            <button class="btn-save" style="width:100%; margin-top:10px;" onclick="calcTapuKomisyon()">HESAPLA</button>
            <div id="resTapu" class="result-box" style="display:none; text-align:left; font-size:13px;"></div>
        </div>
        <div id="tabEmsal" class="tab-content">
            <div class="form-group"><label>Arsa AlanÄ± (mÂ²)</label><input type="number" id="calcArsaM2"></div>
            <div class="form-group"><label>KAKS / Emsal OranÄ±</label><input type="number" id="calcKaks" placeholder="Ã–rn: 1.5"></div>
            <button class="btn-save" style="width:100%; margin-top:10px;" onclick="calcEmsal()">HESAPLA</button>
            <div id="resEmsal" class="result-box" style="display:none;"></div>
        </div>
        <div id="tabVergi" class="tab-content">
            <div class="form-group"><label>Emlak TÃ¼rÃ¼</label></div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <select id="calcVergiType" style="flex:1;">
                    <option value="0.002">Konut (B.Åehir - %0.2)</option>
                    <option value="0.001">Konut (Normal - %0.1)</option>
                    <option value="0.004">Ä°ÅŸyeri (B.Åehir - %0.4)</option>
                    <option value="0.002">Ä°ÅŸyeri (Normal - %0.2)</option>
                    <option value="0.006">Arsa (B.Åehir - %0.6)</option>
                </select>
            </div>
            <div class="form-group"><label>RayiÃ§ Bedel</label><input type="number" id="calcVergiDeger" placeholder="Bedel"></div>
            <button class="btn-save" style="width:100%; margin-top:5px;" onclick="calcEmlakVergisi()">VERGÄ° HESAPLA</button>
            <div id="resVergi" class="result-box" style="display:none;"></div>
        </div>
    </div>
</div>

<script>
    function checkLogin() { if(document.getElementById('loginPin').value==="1923"){document.getElementById('loginOverlay').style.display='none';document.getElementById('appContainer').style.display='block';window.scrollTo(0,0); renderChecklist();}else{alert("HatalÄ± Åifre!");} }

    const antalyaData = { "Akseki": ["Merkez"], "Aksu": ["Merkez","AltÄ±ntaÅŸ","Kundu","PÄ±narlÄ±","Macun"], "Alanya": ["Merkez","Mahmutlar","Avsallar","Oba","Kestel"], "Demre": ["Merkez"], "DÃ¶ÅŸemealtÄ±": ["Merkez","YenikÃ¶y","YeÅŸilbayÄ±r","AltÄ±nkale"], "ElmalÄ±": ["Merkez"], "Finike": ["Merkez"], "GazipaÅŸa": ["Merkez"], "GÃ¼ndoÄŸmuÅŸ": ["Merkez"], "Ä°bradÄ±": ["Merkez"], "KaÅŸ": ["Merkez","Kalkan"], "Kemer": ["Merkez","GÃ¶ynÃ¼k","Beldibi","Tekirova"], "Kepez": ["Merkez","Varsak","SÃ¼tÃ§Ã¼ler","GÃ¼lveren","KÃ¼ltÃ¼r"], "KonyaaltÄ±": ["Merkez","Liman","Hurma","UncalÄ±","GÃ¼rsu","SarÄ±su"], "Korkuteli": ["Merkez"], "Kumluca": ["Merkez","Mavikent","Adrasan"], "Manavgat": ["Merkez","Side","Sorgun","IlÄ±ca"], "MuratpaÅŸa": ["Merkez","Lara","Fener","ÅirinyalÄ±","KÄ±rcami","Meltem"], "Serik": ["Merkez","Belek","Kadriye","BoÄŸazkent"] };
    const turkiyeData = { "Adana": [], "AdÄ±yaman": [], "Afyonkarahisar": [], "AÄŸrÄ±": [], "Aksaray": [], "Amasya": [], "Ankara": ["Ã‡ankaya","KeÃ§iÃ¶ren","Yenimahalle","Mamak","Etimesgut","Sincan","AltÄ±ndaÄŸ","Pursaklar","GÃ¶lbaÅŸÄ±"], "Antalya": Object.keys(antalyaData).sort(), "Ardahan": [], "Artvin": [], "AydÄ±n": [], "BalÄ±kesir": [], "BartÄ±n": [], "Batman": [], "Bayburt": [], "Bilecik": [], "BingÃ¶l": [], "Bitlis": [], "Bolu": [], "Burdur": [], "Bursa": [], "Ã‡anakkale": [], "Ã‡ankÄ±rÄ±": [], "Ã‡orum": [], "Denizli": [], "DiyarbakÄ±r": [], "DÃ¼zce": [], "Edirne": [], "ElazÄ±ÄŸ": [], "Erzincan": [], "Erzurum": [], "EskiÅŸehir": [], "Gaziantep": [], "Giresun": [], "GÃ¼mÃ¼ÅŸhane": [], "Hakkari": [], "Hatay": [], "IÄŸdÄ±r": [], "Isparta": [], "Ä°stanbul": ["Esenyurt","KÃ¼Ã§Ã¼kÃ§ekmece","BaÄŸcÄ±lar","Ãœmraniye","Pendik","BahÃ§elievler","ÃœskÃ¼dar","KadÄ±kÃ¶y","Kartal","GaziosmanpaÅŸa","ÅiÅŸli","BeÅŸiktaÅŸ","SarÄ±yer","Fatih"], "Ä°zmir": ["Buca","KarabaÄŸlar","Bornova","KarÅŸÄ±yaka","Konak","BayraklÄ±","Ã‡iÄŸli","Menemen","TorbalÄ±"], "KahramanmaraÅŸ": [], "KarabÃ¼k": [], "Karaman": [], "Kars": [], "Kastamonu": [], "Kayseri": [], "KÄ±rÄ±kkale": [], "KÄ±rklareli": [], "KÄ±rÅŸehir": [], "Kilis": [], "Kocaeli": [], "Konya": [], "KÃ¼tahya": [], "Malatya": [], "Manisa": [], "Mardin": [], "Mersin": [], "MuÄŸla": ["Bodrum","Fethiye","Marmaris","DatÃ§a","MenteÅŸe","Milas"], "MuÅŸ": [], "NevÅŸehir": [], "NiÄŸde": [], "Ordu": [], "Osmaniye": [], "Rize": [], "Sakarya": [], "Samsun": [], "Siirt": [], "Sinop": [], "Sivas": [], "ÅanlÄ±urfa": [], "ÅÄ±rnak": [], "TekirdaÄŸ": [], "Tokat": [], "Trabzon": [], "Tunceli": [], "UÅŸak": [], "Van": [], "Yalova": [], "Yozgat": [], "Zonguldak": [] };

    const floorList = ["GiriÅŸ","Zemin","1","2","3","4","5","6","7","8","9","10+","Ã‡atÄ± Dubleks","BahÃ§e Dubleks","MÃ¼stakil"];
    const typeList = ["Daire","Villa","Proje","Arsa","Ä°ÅŸyeri","Turistik","Komple Bina","BahÃ§e","Tarla","Zeytinlik"];

    let crmData = { investors: [], network: [] };
    let portfolio = [];
    let checklist = [];

    try { const sC = localStorage.getItem('KaracabayRE_CRM_v19'); if(sC) crmData = JSON.parse(sC); } catch(e){}
    try { const sP = localStorage.getItem('KaracabayRE_EST_DB_v19'); if(sP) portfolio = JSON.parse(sP); } catch(e){}
    try { const sCh = localStorage.getItem('KaracabayRE_CHK_v1'); if(sCh) checklist = JSON.parse(sCh); } catch(e){}

    let editingId = null; let crmEditingId = null;

    window.onload = function() { populateSelects(); renderTable(); renderChecklist(); };

    function handleCityChange(citySelectId, districtSelectId, datalistId) {
        const city = document.getElementById(citySelectId).value;
        const districtSelect = document.getElementById(districtSelectId);
        
        if(districtSelectId === 'filterDistrict') {
             districtSelect.innerHTML = '<option value="all">Ä°lÃ§e</option>';
        } else {
             districtSelect.innerHTML = '<option value="">SeÃ§iniz</option>'; 
        }

        if (city === "all") return;
        const districts = turkiyeData[city] || [];
        districts.sort().forEach(d => { const opt = document.createElement('option'); opt.value = d; opt.innerText = d; districtSelect.appendChild(opt); });
        const dl = document.getElementById(datalistId); dl.innerHTML = '';
    }

    // --- TEMÄ°ZLEME FONKSÄ°YONU ---
    function clearFilters() {
        document.getElementById('searchBox').value = '';
        document.getElementById('filterOwnership').value = 'all';
        document.getElementById('filterType').value = 'all';
        document.getElementById('filterStatus').value = 'all';

        // VarsayÄ±lan olarak Antalya'ya dÃ¶n
        const citySelect = document.getElementById('filterCity');
        citySelect.value = 'Antalya'; 

        handleCityChange('filterCity', 'filterDistrict', 'dl_mahalle_filtre');

        const districtSelect = document.getElementById('filterDistrict');
        districtSelect.value = 'all';

        document.getElementById('filterNeighborhood').value = '';
        document.getElementById('filterRooms').value = '';
        document.getElementById('filterMinPrice').value = '';
        document.getElementById('filterMaxPrice').value = '';
        
        document.getElementById('dl_mahalle_filtre').innerHTML = '';

        const masterCb = document.getElementById('masterCheckbox');
        if(masterCb) masterCb.checked = false;
        
        renderTable();
    }

    function handleSave() {
        const data = {
            id: editingId ? editingId : Date.now(),
            ownership: document.getElementById('inpOwnership').value,
            type: document.getElementById('inpType').value,
            status: document.getElementById('inpStatus').value,
            city: document.getElementById('inpCity').value,
            district: document.getElementById('inpDistrict').value,
            neighborhood: document.getElementById('inpNeighborhood').value,
            rooms: document.getElementById('inpRooms').value,
            floor: document.getElementById('inpFloor').value,
            floorCount: document.getElementById('inpFloorCount').value,
            gross: document.getElementById('inpGross').value,
            net: document.getElementById('inpNet').value,
            price: document.getElementById('inpPrice').value,
            currency: document.getElementById('inpCurrency').value,
            authStart: document.getElementById('inpAuthStart').value,
            authEnd: document.getElementById('inpAuthEnd').value,
            ref: document.getElementById('inpRef').value,
            phone: document.getElementById('inpPhone').value,
            link: document.getElementById('inpLink').value,
            desc: document.getElementById('inpDesc').value
        };
        if(!data.district || !data.price) { alert("Ä°lÃ§e ve Fiyat zorunlu!"); return; }
        if (editingId) portfolio[portfolio.findIndex(p => p.id === editingId)] = data; else portfolio.push(data);
        saveToDisk(); renderTable(); resetForm();
    }

    function editRecord(id) {
        const item = portfolio.find(p => p.id === id); if(!item) return; editingId = id;
        document.getElementById('formTitle').innerText = "âœï¸ DÃ¼zenleniyor..."; document.getElementById('btnSave').innerText = "GÃœNCELLE"; document.getElementById('btnDelete').style.display = "block"; document.getElementById('btnCancel').style.display = "block";
        document.getElementById('inpOwnership').value = item.ownership || 'BANA AÄ°T';
        document.getElementById('inpType').value = item.type; document.getElementById('inpStatus').value = item.status;
        document.getElementById('inpCity').value = item.city || "Antalya";
        handleCityChange('inpCity', 'inpDistrict', 'dl_mahalle_ekle'); 
        document.getElementById('inpDistrict').value = item.district; 
        loadMahalleler('inpCity', 'inpDistrict', 'dl_mahalle_ekle');
        setTimeout(() => { document.getElementById('inpNeighborhood').value = item.neighborhood; }, 50);
        document.getElementById('inpRooms').value = item.rooms;
        document.getElementById('inpFloor').value = item.floor; document.getElementById('inpFloorCount').value = item.floorCount || '';
        document.getElementById('inpGross').value = item.gross; document.getElementById('inpNet').value = item.net;
        document.getElementById('inpPrice').value = item.price; document.getElementById('inpCurrency').value = item.currency || 'â‚º';
        document.getElementById('inpAuthStart').value = item.authStart; document.getElementById('inpAuthEnd').value = item.authEnd;
        document.getElementById('inpRef').value = item.ref; document.getElementById('inpPhone').value = item.phone;
        document.getElementById('inpLink').value = item.link; document.getElementById('inpDesc').value = item.desc;
        window.scrollTo(0,0);
    }

    function toggleAllSelections(source) {
        const checkboxes = document.querySelectorAll('#tableBody input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = source.checked;
            toggleRowSelection(cb);
        });
    }

    function toggleRowSelection(checkbox) { const row = checkbox.closest('tr'); if(checkbox.checked) row.classList.add('row-selected'); else row.classList.remove('row-selected'); }
    
    // --- GÃœÃ‡LENDÄ°RÄ°LMÄ°Å YAZDIRMA FONKSÄ°YONU (iOS Fix Dahil) ---
    function printSelected() { 
        const selectedCount = document.querySelectorAll('.row-selected').length; 
        if(selectedCount === 0) { 
            alert("âš ï¸ LÃ¼tfen listeden yazdÄ±rmak istediÄŸiniz kayÄ±tlarÄ± seÃ§in (sol baÅŸtaki kutucuklar)."); 
            return; 
        } 
        
        // SÄ±nÄ±fÄ± ekle (filtreler devreye girer)
        document.body.classList.add('print-selected-mode'); 
        
        // iOS iÃ§in gecikme
        setTimeout(function() {
            window.print(); 
            
            // Pencere kapandÄ±ktan sonra sÄ±nÄ±fÄ± kaldÄ±r (Uzun sÃ¼re)
            setTimeout(function() {
                document.body.classList.remove('print-selected-mode'); 
            }, 2000); 
        }, 100);
    }
    
    function sendSelectedToWhatsapp() {
        const selectedCheckboxes = document.querySelectorAll('.row-selected input[type="checkbox"]');
        if(selectedCheckboxes.length === 0) { alert("LÃ¼tfen Ã¶nce listeden gÃ¶ndermek istediÄŸiniz portfÃ¶yleri seÃ§in."); return; }
        
        let msg = "*ğŸ“¢ SEÃ‡Ä°LEN PORTFÃ–YLER*\n\n";
        
        selectedCheckboxes.forEach(cb => {
            const row = cb.closest('tr');
            const editBtn = row.querySelector('button[onclick^="editRecord"]');
            if(editBtn) {
                const idMatch = editBtn.getAttribute('onclick').match(/\d+/);
                if(idMatch) {
                    const id = parseInt(idMatch[0]);
                    const item = portfolio.find(p => p.id === id);
                    if(item) {
                        const city = item.city || "Antalya";
                        const price = item.price + " " + (item.currency || 'â‚º');
                        const loc = `${city}/${item.district} - ${item.neighborhood}`;
                        const typeStatus = `${item.status} ${item.type}`;
                        
                        msg += `ğŸ  *${typeStatus}*\nğŸ“ ${loc}\nğŸ’° ${price}\nâ„¹ï¸ ${item.rooms} | ${item.gross}mÂ²\n`;
                        if(item.link) {
                            const links = item.link.split('\n');
                            links.forEach(l => { if(l.trim().startsWith('http')) msg += `ğŸ”— ${l.trim()}\n`; });
                        }
                        msg += "-------------------\n";
                    }
                }
            }
        });
        window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
        const term = document.getElementById('searchBox').value.toLowerCase();
        
        const fOwn = document.getElementById('filterOwnership').value;
        const fStatus = document.getElementById('filterStatus').value;
        const fType = document.getElementById('filterType').value;
        const fCity = document.getElementById('filterCity').value;
        const fDist = document.getElementById('filterDistrict').value;
        const fNeigh = document.getElementById('filterNeighborhood').value.toLowerCase();
        const fRoom = document.getElementById('filterRooms').value.toLowerCase();
        const minP = parsePrice(document.getElementById('filterMinPrice').value);
        const maxP = parsePrice(document.getElementById('filterMaxPrice').value);

        const filtered = portfolio.filter(item => {
            const txt = (item.district + item.neighborhood + item.ref + item.phone + item.desc + item.type + (item.city||'')).toLowerCase();
            const p = parsePrice(item.price);
            const own = item.ownership || 'BANA AÄ°T';
            const roomVal = (item.rooms || '').toLowerCase();
            const cityVal = item.city || "Antalya"; 
            
            return txt.includes(term) &&
                   ((fOwn === 'all') || (own === fOwn)) &&
                   ((fType === 'all') || (item.type === fType)) &&
                   ((fStatus === 'all') || (item.status === fStatus)) &&
                   ((fCity === 'all') || (cityVal === fCity)) &&
                   ((fDist === 'all') || (item.district === fDist)) &&
                   (fNeigh === '' || item.neighborhood.toLowerCase().includes(fNeigh)) &&
                   (fRoom === '' || roomVal.includes(fRoom)) &&
                   (minP === 0 || p >= minP) && (maxP === 0 || p <= maxP);
        });

        filtered.sort((a, b) => {
            const getStatusScore = (s) => { if (s === 'SatÄ±ldÄ±') return 3; if (s === 'KiralandÄ±') return 2; return 1; };
            const scoreA = getStatusScore(a.status); const scoreB = getStatusScore(b.status);
            if (scoreA !== scoreB) return scoreA - scoreB;
            if (scoreA === 1) { const ownerA = a.ownership || 'BANA AÄ°T'; const ownerB = b.ownership || 'BANA AÄ°T'; if (ownerA !== ownerB) return ownerA === 'BANA AÄ°T' ? -1 : 1; }
            const typeA = (a.type || '').toLowerCase(); const typeB = (b.type || '').toLowerCase(); if (typeA !== typeB) return typeA.localeCompare(typeB, 'tr');
            return b.id - a.id;
        });

        filtered.forEach(item => {
            let badgeClass = item.status.includes('SatÄ±ldÄ±')||item.status.includes('KiralandÄ±') ? 'kirmizi-etiket' : (item.status==='KiralÄ±k'?'kiralik':'satilik');
            let rowClass = item.status === 'SatÄ±ldÄ±' ? 'row-sold' : (item.status === 'KiralandÄ±' ? 'row-rented' : '');
            let floorInfo = item.floor; if(item.floorCount) floorInfo += `<br><small>Top: ${item.floorCount}</small>`;
            let currSymbol = item.currency || 'â‚º';
            let btnDesc = item.desc ? `<button onclick="document.getElementById('modalText').innerText='${item.desc.replace(/\n/g,'\\n').replace(/'/g, "\\'")}'; document.getElementById('descModal').style.display='block';" class="btn-icon no-print" style="background:#9b59b6;border:none;color:white;border-radius:3px;cursor:pointer;">ğŸ“</button>` : '-';
            let own = item.ownership || 'BANA AÄ°T'; let ownBadgeClass = (own === 'PAYLAÅIMLI') ? 'badge-shared' : 'badge-own'; let ownLabel = (own === 'PAYLAÅIMLI') ? 'PAYLAÅIMLI' : 'BANA AÄ°T';
            let cityDisplay = item.city && item.city !== "Antalya" ? `<b>${item.city}</b>/` : "";

            let btnLinkHtml = '-'; 
            if (item.link && item.link.trim() !== "") { 
                btnLinkHtml = ''; 
                item.link.split('\n').forEach(l => { 
                    let r = l.trim(); 
                    if(r){ 
                        let lbl="Web Linki"; let cls=""; let isF=false; let icon = "fa-link";
                        if(r.includes("maps") || r.includes("goo.gl") || r.includes("konum")) { lbl="KONUM"; cls="link-maps"; icon="fa-location-dot"; }
                        else if(r.includes("sahibinden")) {lbl="Sahibinden";cls="link-sahibinden";} 
                        else if(r.includes("hepsi")) {lbl="HepsiEmlak";cls="link-hepsi";} 
                        else if(r.includes("obudur")) {lbl="Obudur";cls="link-obudur";} 
                        else if(r.includes("facebook")||r.includes("instagram")){lbl="Sosyal";cls="link-sosyal";} 
                        else if(r.includes("â–¸")||r.includes("icloud")||r.startsWith("/")||r.startsWith("\\\\")||/^[a-z]:/i.test(r)||r.includes("\\")||/\.(pdf|docx?|txt|jpg|png)$/i.test(r)){lbl="Dosya";cls="link-dosya";isF=true;} 
                        let href=r; if(!isF && !href.startsWith('http')) href='https://'+href; 
                        if(isF) btnLinkHtml += `<button onclick="alert('Dosya Yolu:\\n${r.replace(/\\/g,'\\\\')}')" class="direct-link-btn ${cls} no-print" style="border:none;cursor:pointer;">${lbl}</button><br>`; 
                        else btnLinkHtml += `<a href="${href}" target="_blank" class="direct-link-btn ${cls} no-print"><i class="fa-solid ${icon}"></i> ${lbl}</a><br>`; 
                    }
                }); 
            }
            let authHtml = item.authEnd ? `<small>${item.authEnd}</small>` : '-';
            tbody.innerHTML += `
            <tr class="${rowClass}">
                <td class="select-col-cell no-print"><input type="checkbox" onchange="toggleRowSelection(this)" style="transform:scale(1.3); cursor:pointer;"></td>
                <td><span class="badge ${badgeClass}">${item.status}</span><br><span class="badge ${ownBadgeClass}">${ownLabel}</span><br><span class="type-text">${item.type.toUpperCase()}</span></td>
                <td>${cityDisplay}<b>${item.district}</b><br><small>${item.neighborhood}</small></td>
                <td>${item.rooms}<br><small>${floorInfo}</small></td>
                <td>${item.gross}/${item.net}</td>
                <td style="color:#27ae60;font-weight:bold;">${item.price} ${currSymbol}</td>
                <td>${item.ref}<br><small>${item.phone}</small></td>
                <td>${authHtml}</td>
                <td class="no-print">${btnLinkHtml}</td>
                <td class="no-print">${btnDesc}</td>
                <td class="no-print"><button onclick="editRecord(${item.id})" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">DÃœZENLE</button></td>
                <td class="print-only">${item.desc}</td>
            </tr>`;
        });
    }

    function resetForm() {
        editingId = null;
        document.getElementById('formTitle').innerText = "â• Yeni PortfÃ¶y Ekle";
        document.getElementById('btnSave').innerText = "KAYDET";
        document.getElementById('btnDelete').style.display = "none";
        document.getElementById('btnCancel').style.display = "none";
        document.querySelectorAll('.input-panel input, .input-panel select, .input-panel textarea').forEach(i => i.value = '');
        document.getElementById('inpType').value = "Daire";
        document.getElementById('inpStatus').value = "SatÄ±lÄ±k";
        document.getElementById('inpCurrency').value = "â‚º";
        document.getElementById('inpOwnership').value = "BANA AÄ°T";
        document.getElementById('inpCity').value = "Antalya";
        handleCityChange('inpCity', 'inpDistrict', 'dl_mahalle_ekle');
    }

    function renderChecklist() { 
        const c = document.getElementById('checklistContainer'); c.innerHTML = ''; 
        const badge = document.getElementById('chkBadge');
        const pendingCount = checklist.filter(item => !item.done).length;
        badge.innerText = pendingCount;
        badge.style.display = pendingCount > 0 ? 'inline-block' : 'none'; 
        if(checklist.length === 0) { c.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">HenÃ¼z hatÄ±rlatma yok.</div>'; return; } 
        checklist.forEach((item, index) => { 
            const cls = item.done ? 'checked' : ''; 
            c.innerHTML += `<div class="checklist-item ${cls}"><div style="display:flex; align-items:center; cursor:pointer; flex:1;" onclick="toggleCheck(${index})"><i class="fa-regular ${item.done ? 'fa-square-check' : 'fa-square'}" style="color:${item.done ? '#27ae60':'#ccc'}; font-size:18px;"></i><span style="margin-left:10px; flex:1;">${item.text}</span></div><button onclick="deleteCheck(${index})" style="background:none; border:none; color:#c0392b; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></div>`; 
        }); 
    }
    
    function addCheckItem() { const t = document.getElementById('newCheckItem').value; if(!t) return; checklist.push({text: t, done: false}); localStorage.setItem('KaracabayRE_CHK_v1', JSON.stringify(checklist)); document.getElementById('newCheckItem').value=''; renderChecklist(); }
    function toggleCheck(i) { checklist[i].done = !checklist[i].done; localStorage.setItem('KaracabayRE_CHK_v1', JSON.stringify(checklist)); renderChecklist(); }
    function deleteCheck(i) { if(confirm('Silinsin mi?')) { checklist.splice(i, 1); localStorage.setItem('KaracabayRE_CHK_v1', JSON.stringify(checklist)); renderChecklist(); } }
    
    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function formatPhone(input) { let n = input.value.replace(/\D/g, ''); if(n.length===0){input.value='';return;} if(n[0]!=='0') n='0'+n; n=n.substring(0,11); input.value = n; }
    function formatCurrency(input) { let v=input.value.replace(/\D/g, ''); input.value=v.replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function parsePrice(v) { return v ? parseInt(v.toString().replace(/\./g,'')) : 0; }
    function openModal(id) { document.getElementById(id).style.display = 'block'; document.body.classList.add('no-scroll'); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; document.body.classList.remove('no-scroll'); }
    function closeModalOutside(e, id) { if(e.target == document.getElementById(id)) closeModal(id); }
    function saveToDisk() { localStorage.setItem('KaracabayRE_EST_DB_v19', JSON.stringify(portfolio)); }
    function downloadData() { const d = { portfolio: portfolio, crm: crmData, checklist: checklist }; const a = document.createElement('a'); a.href = "data:text/plain;charset=utf-8," + encodeURIComponent(JSON.stringify(d)); a.download = "Karacabay_Yedek.json"; document.body.appendChild(a); a.click(); a.remove(); }
    
    // --- GÃœÃ‡LENDÄ°RÄ°LMÄ°Å YÃœKLEME FONKSÄ°YONU ---
    function uploadData(input) { 
        const f = input.files[0]; if(!f) return; 
        const r = new FileReader(); 
        r.onload = e => { 
            try {
                const d = JSON.parse(e.target.result); 
                if(confirm("Mevcut verilerin Ã¼zerine yedek yÃ¼klensin mi?")) { 
                    if(d.portfolio && Array.isArray(d.portfolio)) { 
                        portfolio=d.portfolio; crmData=d.crm||{investors:[],network:[]}; checklist=d.checklist||[]; 
                    } else if(Array.isArray(d)) {
                         portfolio=d; 
                    } else {
                         alert("Yedek dosyasÄ± formatÄ± tanÄ±namadÄ±!"); return;
                    }
                    saveToDisk(); 
                    localStorage.setItem('KaracabayRE_CRM_v19', JSON.stringify(crmData)); 
                    localStorage.setItem('KaracabayRE_CHK_v1', JSON.stringify(checklist)); 
                    alert("Yedek baÅŸarÄ±yla yÃ¼klendi! LÃ¼tfen bekleyin...");
                    
                    const fCity = document.getElementById('filterCity');
                    fCity.innerHTML = '<option value="all">TÃ¼m Ä°ller</option><option value="Antalya">Antalya</option>';
                    Object.keys(turkiyeData).sort().forEach(city => { if(city !== "Antalya") fCity.innerHTML += `<option value="${city}">${city}</option>`; });
                    fCity.value = 'all';
                    handleCityChange('filterCity', 'filterDistrict', 'dl_mahalle_filtre');
                    renderTable();
                    renderChecklist();
                    input.value = '';
                } 
            } catch(err) { alert("Dosya hatasÄ±: " + err); input.value = ''; }
        }; 
        r.readAsText(f); 
    }
    
    function deleteFromForm() { if(confirm('SÄ°LÄ°NECEK!')) { portfolio = portfolio.filter(item => item.id !== editingId); saveToDisk(); renderTable(); resetForm(); } }
    
    function populateSelects() { 
        const iC = document.getElementById('inpCity'); const fC = document.getElementById('filterCity');
        iC.innerHTML = '<option value="Antalya">Antalya</option>'; 
        // Filtreye Ã¶nce TÃ¼m Ä°ller ve Antalya ekle
        fC.innerHTML = '<option value="all">TÃ¼m Ä°ller</option><option value="Antalya">Antalya</option>';
        
        Object.keys(turkiyeData).sort().forEach(city => { if(city !== "Antalya") iC.innerHTML += `<option value="${city}">${city}</option>`; fC.innerHTML += `<option value="${city}">${city}</option>`; });
        
        handleCityChange('inpCity', 'inpDistrict', 'dl_mahalle_ekle');
        
        // FÄ°LTRE Ä°Ã‡Ä°N VARSAYILAN ANTALYA YAP
        fC.value = "Antalya";
        handleCityChange('filterCity', 'filterDistrict', 'dl_mahalle_filtre');

        const tS=document.getElementById('inpType'), fT=document.getElementById('filterType'); 
        typeList.forEach(t=>{tS.innerHTML+=`<option>${t}</option>`;fT.innerHTML+=`<option>${t}</option>`;});
        const fL=document.getElementById('inpFloor'); floorList.forEach(f=>fL.innerHTML+=`<option>${f}</option>`); 
    }

    function loadMahalleler(citySelectId, districtSelectId, datalistId) { 
        const city = document.getElementById(citySelectId).value; const district = document.getElementById(districtSelectId).value; const dl = document.getElementById(datalistId); dl.innerHTML = ''; 
        if(city === "Antalya" && antalyaData[district]) { antalyaData[district].sort().forEach(m=>{ let o=document.createElement('option'); o.value=m; dl.appendChild(o); }); }
    }
    
    // CRM
    function openCRM() { openModal('crmModal'); renderInvestors(); renderNetwork(); document.getElementById('netLastCall').valueAsDate = new Date(); }
    function switchCRMTab(tab) { document.querySelectorAll('.crm-section').forEach(s => s.style.display = 'none'); document.querySelectorAll('.crm-tab').forEach(t => t.classList.remove('active')); if(tab === 'investors') { document.getElementById('crmInvestors').style.display = 'block'; document.getElementById('tab1').classList.add('active'); } else { document.getElementById('crmNetwork').style.display = 'block'; document.getElementById('tab2').classList.add('active'); } resetCRMForm('investors'); resetCRMForm('network'); }
    function saveCRMInvestor() { const inv = { id: crmEditingId ? crmEditingId : Date.now(), name: document.getElementById('invName').value, phone: document.getElementById('invPhone').value, type: document.getElementById('invType').value, region: document.getElementById('invRegion').value, budget: document.getElementById('invBudget').value, status: document.getElementById('invStatus').value, note: document.getElementById('invNote').value }; if(!inv.name) return; if(crmEditingId) crmData.investors[crmData.investors.findIndex(i => i.id === crmEditingId)] = inv; else crmData.investors.push(inv); saveCRM(); renderInvestors(); resetCRMForm('investors'); }
    function saveCRMNetwork() { const net = { id: crmEditingId ? crmEditingId : Date.now(), name: document.getElementById('netName').value, phone: document.getElementById('netPhone').value, job: document.getElementById('netJob').value, city: document.getElementById('netCity').value, relation: document.getElementById('netRelation').value, lastCall: document.getElementById('netLastCall').value || new Date().toISOString().split('T')[0], note: document.getElementById('netNote').value }; if(!net.name) return; if(crmEditingId) crmData.network[crmData.network.findIndex(n => n.id === crmEditingId)] = net; else crmData.network.push(net); saveCRM(); renderNetwork(); resetCRMForm('network'); }
    function deleteCRMInvestor() { if(confirm('Sil?')) { crmData.investors = crmData.investors.filter(i => i.id !== crmEditingId); saveCRM(); renderInvestors(); resetCRMForm('investors'); } }
    function deleteCRMNetwork() { if(confirm('Sil?')) { crmData.network = crmData.network.filter(n => n.id !== crmEditingId); saveCRM(); renderNetwork(); resetCRMForm('network'); } }
    function resetCRMForm(type) { crmEditingId = null; if(type === 'investors') { document.querySelectorAll('#crmInvestors input, #crmInvestors textarea').forEach(i=>i.value=''); document.getElementById('btnInvSave').innerText = "KAYDET"; document.getElementById('btnInvDelete').style.display = "none"; } else { document.querySelectorAll('#crmNetwork input, #crmNetwork textarea').forEach(i=>i.value=''); document.getElementById('netCity').value = 'Antalya'; document.getElementById('netLastCall').valueAsDate = new Date(); document.getElementById('btnNetSave').innerText = "KAYDET"; document.getElementById('btnNetDelete').style.display = "none"; } }
    
    // GÃœNCELLENEN CRM LÄ°STELEME
    function renderInvestors() { 
        const tbody = document.getElementById('investorTableBody'); tbody.innerHTML = ''; 
        crmData.investors.forEach(inv => { 
            let sClass = inv.status==='SÄ±cak'?'badge-sicak':(inv.status==='IlÄ±k'?'badge-ilik':'badge-soguk'); 
            tbody.innerHTML += `<tr><td><b>${inv.name}</b></td><td>${inv.phone}</td><td>${inv.type} - ${inv.region}</td><td>${inv.budget} TL</td><td><span class="badge ${sClass}">${inv.status}</span></td><td><small>${inv.note || '-'}</small></td><td><button onclick="editCRMInvestor(${inv.id})">DÃœZENLE</button></td></tr>`; 
        }); 
    }
    
    // YENÄ° GÃœNCELLEME BURADA: Ä°KÄ° BUTON TEK SÃœTUNDA BÄ°RLEÅTÄ°RÄ°LDÄ°
    function renderNetwork() { 
        const tbody = document.getElementById('networkTableBody'); tbody.innerHTML = ''; const today = new Date(); 
        crmData.network.forEach(net => { 
            let lastCallDate = new Date(net.lastCall || today); let diffTime = Math.abs(today - lastCallDate); let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); let statusBadge = ''; 
            if(diffDays <= 30) statusBadge = `<span class="badge badge-time-ok">${diffDays} GÃ¼n Oldu</span>`; else if(diffDays <= 45) statusBadge = `<span class="badge badge-time-warn">${diffDays} GÃ¼n Oldu</span>`; else statusBadge = `<span class="badge badge-time-danger">âš ï¸ ${diffDays} GÃ¼n! (ARA)</span>`; 
            tbody.innerHTML += `
            <tr>
                <td><b>${net.name}</b></td>
                <td>${net.job}<br><small>${net.city}</small></td>
                <td>${net.phone}</td>
                <td>${net.relation}</td>
                <td>${net.lastCall}<br>${statusBadge}</td>
                <td><span class="badge ${getStatusClass(diffDays)}">${getStatusText(diffDays)}</span></td>
                <td><small>${net.note || '-'}</small></td>
                <td style="display:flex; gap:5px; justify-content:center;">
                    <button onclick="resetNetworkTimer(${net.id})" style="background:#3498db; color:white; border:none; padding:4px 8px; border-radius:3px; cursor:pointer; font-size:11px;">ğŸ“ GÃ–RÃœÅTÃœM</button>
                    <button onclick="editCRMNetwork(${net.id})" style="background:#f39c12; color:white; border:none; padding:4px 8px; border-radius:3px; cursor:pointer; font-size:11px;">DÃœZENLE</button>
                </td>
            </tr>`; 
        }); 
    }
    
    function getStatusClass(days) { return days<=30 ? 'badge-sicak' : (days<=45 ? 'badge-ilik' : 'badge-soguk'); }
    function getStatusText(days) { return days<=30 ? 'Aktif' : (days<=45 ? 'Normal' : 'Pasif'); }

    function resetNetworkTimer(id) { if(confirm("GÃ¶rÃ¼ÅŸme yapÄ±ldÄ± olarak iÅŸaretlensin mi? Tarih bugÃ¼n olacak.")) { const idx = crmData.network.findIndex(n => n.id === id); if(idx > -1) { crmData.network[idx].lastCall = new Date().toISOString().split('T')[0]; saveCRM(); renderNetwork(); } } }
    function editCRMInvestor(id) { const i = crmData.investors.find(x => x.id === id); if(!i) return; crmEditingId = id; document.getElementById('invName').value = i.name; document.getElementById('invPhone').value = i.phone; document.getElementById('invType').value = i.type; document.getElementById('invRegion').value = i.region; document.getElementById('invBudget').value = i.budget; document.getElementById('invStatus').value = i.status; document.getElementById('invNote').value = i.note; document.getElementById('btnInvSave').innerText = "GÃœNCELLE"; document.getElementById('btnInvDelete').style.display = "inline-block"; }
    function editCRMNetwork(id) { const n = crmData.network.find(x => x.id === id); if(!n) return; crmEditingId = id; document.getElementById('netName').value = n.name; document.getElementById('netPhone').value = n.phone; document.getElementById('netJob').value = n.job; document.getElementById('netCity').value = n.city; document.getElementById('netRelation').value = n.relation; document.getElementById('netNote').value = n.note; document.getElementById('netLastCall').value = n.lastCall; document.getElementById('btnNetSave').innerText = "GÃœNCELLE"; document.getElementById('btnNetDelete').style.display = "inline-block"; }
    function saveCRM() { localStorage.setItem('KaracabayRE_CRM_v19', JSON.stringify(crmData)); }

    // TOOLS
    let calcExp = ""; function calcInput(v) { if(v === '%') { calcExp += '/100'; } else { calcExp += v; } document.getElementById('calcDisplay').value = calcExp; } function calcClear() { calcExp = ""; document.getElementById('calcDisplay').value = ""; } function calcResult() { try { calcExp = eval(calcExp).toString(); document.getElementById('calcDisplay').value = calcExp; } catch(e) { document.getElementById('calcDisplay').value = "Hata"; calcExp=""; } }
    async function fetchCurrency() { try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/TRY'); const data = await res.json(); if(document.getElementById('usdRate').value === "") document.getElementById('usdRate').value = (1 / data.rates.USD).toFixed(4); if(document.getElementById('eurRate').value === "") document.getElementById('eurRate').value = (1 / data.rates.EUR).toFixed(4); } catch(e) {} }
    function calculateCurrencyTotal() { let amount = parseFloat(document.getElementById('calcCurrAmount').value); let type = document.getElementById('calcCurrType').value; let rate = type === 'USD' ? parseFloat(document.getElementById('usdRate').value) : parseFloat(document.getElementById('eurRate').value); if(!amount || !rate) return; document.getElementById('currResText').innerText = (amount * rate).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " TL"; document.getElementById('currencyTotalRes').style.display = 'block'; }
    function switchTab(id) { document.querySelectorAll('.tab-content').forEach(d => d.style.display='none'); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(id).style.display = 'block'; event.currentTarget.classList.add('active'); }
    function calcTapuKomisyon() { let p = parseFloat(document.getElementById('calcPriceComp').value); if(!p) return; let tapu = p * 0.04; let kom = p * 0.02 * 1.20; document.getElementById('resTapu').innerHTML = `<strong>Tapu HarcÄ± (%4):</strong> ${(p*0.04).toLocaleString()} TL<br><strong>Komisyon (%2+KDV):</strong> ${kom.toLocaleString()} TL`; document.getElementById('resTapu').style.display = 'block'; }
    function calcEmsal() { let m2 = parseFloat(document.getElementById('calcArsaM2').value); let kaks = parseFloat(document.getElementById('calcKaks').value); if(!m2 || !kaks) return; document.getElementById('resEmsal').innerHTML = `Ä°nÅŸaat AlanÄ±: <strong>${(m2*kaks).toLocaleString()} mÂ²</strong>`; document.getElementById('resEmsal').style.display = 'block'; }
    function calcEmlakVergisi() { let val = parseFloat(document.getElementById('calcVergiDeger').value); let rate = parseFloat(document.getElementById('calcVergiType').value); if(!val) return; document.getElementById('resVergi').innerHTML = `Vergi: <strong>${(val*rate).toLocaleString()} TL</strong>`; document.getElementById('resVergi').style.display = 'block'; }
</script>
</body>
</html>
